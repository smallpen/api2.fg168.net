# Admin UI - 權限配置指南

## 概述

權限配置是 Dynamic API Manager 安全機制的核心，允許管理員精確控制哪些客戶端可以存取哪些 API Function。系統採用基於角色的存取控制（RBAC）和基於資源的存取控制（RBAC）相結合的方式。

## 權限模型

### 權限層級

Dynamic API Manager 的權限系統包含三個層級：

```
角色 (Role)
  ↓ 包含
權限 (Permission)
  ↓ 授予
API Function 存取權
```

### 核心概念

#### 角色 (Role)

角色是一組權限的集合，代表特定的使用者類型或職責。

**範例**:
- **訪客**: 只能存取公開資訊
- **使用者**: 可以管理自己的資料
- **管理員**: 可以管理所有資料
- **開發者**: 可以存取開發相關的 API

#### 權限 (Permission)

權限定義了對特定資源的操作能力。

**格式**: `{資源類型}.{資源}.{操作}`

**範例**:
- `function.user.read`: 讀取使用者相關的 Function
- `function.order.write`: 寫入訂單相關的 Function
- `function.*.admin`: 管理所有 Function

#### 客戶端 (Client)

客戶端是實際使用 API 的應用程式或服務，可以被分配一個或多個角色。

## 存取權限管理介面

1. 登入 Admin UI
2. 在左側導航選單中點擊「Permissions」
3. 選擇要管理的項目：
   - 角色管理
   - 權限矩陣
   - 客戶端權限

## 角色管理

### 查看角色列表

角色列表頁面顯示所有已定義的角色：

| 角色名稱 | 描述 | 客戶端數量 | 權限數量 | 操作 |
|---------|------|-----------|---------|------|
| 管理員 | 完整的系統存取權限 | 3 | 50 | 編輯、刪除 |
| 使用者 | 一般使用者權限 | 25 | 15 | 編輯、刪除 |
| 訪客 | 唯讀存取權限 | 100 | 5 | 編輯、刪除 |

### 創建新角色

#### 步驟 1: 基本資訊

點擊「創建角色」按鈕，填寫基本資訊：

**必填欄位**:
- **角色名稱**: 例如「內容編輯者」
- **角色識別碼**: 例如「content_editor」（系統內部使用）
- **描述**: 角色的用途說明

**選填欄位**:
- **優先級**: 數字越大優先級越高（用於權限衝突解決）
- **標籤**: 用於分類和搜尋

**範例**:

```
名稱: 內容編輯者
識別碼: content_editor
描述: 可以創建、編輯和發布內容，但不能刪除
優先級: 50
標籤: content, editor
```

#### 步驟 2: 分配權限

選擇此角色應該擁有的權限。

##### 方式 1: 從權限列表選擇

瀏覽所有可用的權限，勾選需要的權限：

```
✓ function.content.read
✓ function.content.create
✓ function.content.update
✗ function.content.delete
✓ function.media.read
✓ function.media.upload
```

##### 方式 2: 使用權限模板

選擇預定義的權限模板，快速配置常見的權限組合：

**可用模板**:
- **唯讀**: 只能讀取資料
- **讀寫**: 可以讀取和寫入資料
- **完整存取**: 包含讀取、寫入和刪除權限

##### 方式 3: 使用萬用字元

使用萬用字元快速授予一組權限：

```
function.content.*     # 所有內容相關的 Function
function.*.read        # 所有 Function 的讀取權限
function.*.*           # 所有 Function 的所有權限
```

#### 步驟 3: 設定限制

為角色設定額外的限制條件：

**可用限制**:
- **IP 限制**: 只允許特定 IP 範圍使用此角色
- **時間限制**: 只在特定時間段內有效
- **速率限制**: 設定此角色的預設速率限制

**範例**:

```
IP 限制: 203.0.113.0/24
時間限制: 週一至週五 09:00-18:00
速率限制: 600 次/分鐘
```

#### 步驟 4: 儲存角色

確認所有設定後，點擊「儲存」按鈕。新角色會立即生效。

### 編輯角色

1. 在角色列表中點擊「編輯」按鈕
2. 修改需要變更的設定
3. 點擊「儲存」按鈕

**注意**: 修改角色會影響所有使用該角色的客戶端。

### 複製角色

快速創建相似的角色：

1. 在角色列表中點擊「複製」按鈕
2. 修改角色名稱和識別碼
3. 調整權限設定
4. 儲存新角色

### 刪除角色

1. 在角色列表中點擊「刪除」按鈕
2. 確認刪除操作

**注意**: 
- 無法刪除系統預設角色（管理員、使用者、訪客）
- 刪除角色前，系統會檢查是否有客戶端正在使用
- 如果有客戶端使用該角色，需要先將客戶端移到其他角色

## 權限矩陣

權限矩陣提供視覺化的方式查看和管理角色與 Function 之間的權限關係。

### 查看權限矩陣

權限矩陣以表格形式顯示：

|  | 管理員 | 使用者 | 訪客 | 內容編輯者 |
|---|--------|--------|------|-----------|
| user.profile | ✓ | ✓ | ✓ | ✓ |
| user.create | ✓ | ✗ | ✗ | ✗ |
| user.update | ✓ | ✓ | ✗ | ✗ |
| user.delete | ✓ | ✗ | ✗ | ✗ |
| content.read | ✓ | ✓ | ✓ | ✓ |
| content.create | ✓ | ✗ | ✗ | ✓ |
| content.update | ✓ | ✗ | ✗ | ✓ |
| content.delete | ✓ | ✗ | ✗ | ✗ |

### 快速編輯權限

在權限矩陣中，可以直接點擊勾選框來授予或撤銷權限：

1. 點擊要修改的勾選框
2. 系統會立即更新權限
3. 變更會記錄到審計日誌

### 篩選和搜尋

使用篩選功能快速找到特定的權限：

- **按 Function 篩選**: 只顯示特定 Function 的權限
- **按角色篩選**: 只顯示特定角色的權限
- **按類別篩選**: 按 Function 類別篩選
- **搜尋**: 根據 Function 名稱或識別碼搜尋

### 匯出權限矩陣

將權限矩陣匯出為 CSV 或 Excel 檔案，用於文件化或審查：

1. 點擊「匯出」按鈕
2. 選擇匯出格式
3. 下載檔案

## 客戶端權限管理

### 為客戶端分配角色

#### 方式 1: 在客戶端管理頁面

1. 進入客戶端詳情頁面
2. 點擊「權限」標籤
3. 在「角色」區塊點擊「新增角色」
4. 選擇要分配的角色
5. 儲存變更

#### 方式 2: 在權限管理頁面

1. 進入「Permissions」→「客戶端權限」
2. 選擇要配置的客戶端
3. 勾選要分配的角色
4. 儲存變更

### 為客戶端分配特定 Function 權限

除了角色權限外，還可以為客戶端分配特定的 Function 權限：

1. 進入客戶端詳情頁面
2. 點擊「權限」標籤
3. 在「Function 權限」區塊點擊「新增權限」
4. 選擇 API Function
5. 選擇允許或拒絕
6. 儲存變更

**範例**:

```
客戶端: 行動應用程式 iOS
角色: 使用者

額外允許的 Function:
  ✓ payment.process (特別授權)
  
額外拒絕的 Function:
  ✗ user.export (明確拒絕)
```

### 權限優先級

當客戶端同時擁有角色權限和特定 Function 權限時，優先級如下：

1. **明確拒絕** (最高優先級)
2. **明確允許**
3. **角色權限**
4. **預設拒絕** (最低優先級)

**範例**:

```
客戶端擁有「使用者」角色，該角色允許 user.update
但客戶端被明確拒絕 user.update
→ 最終結果: 拒絕（明確拒絕優先）

客戶端擁有「訪客」角色，該角色不允許 payment.process
但客戶端被明確允許 payment.process
→ 最終結果: 允許（明確允許優先）
```

### 批次管理客戶端權限

為多個客戶端同時分配或撤銷權限：

1. 在客戶端列表頁面勾選要操作的客戶端
2. 點擊「批次操作」→「管理權限」
3. 選擇要分配或撤銷的角色/權限
4. 確認操作

## Function 權限設定

### 為 Function 設定存取控制

在 Function 編輯頁面，可以設定該 Function 的存取控制：

#### 存取級別

- **公開**: 所有已驗證的客戶端都可以存取
- **限制**: 只有特定角色或客戶端可以存取
- **私有**: 只有管理員可以存取

#### 允許的角色

選擇哪些角色可以存取此 Function：

```
允許的角色:
  ✓ 管理員
  ✓ 使用者
  ✗ 訪客
```

#### 允許的客戶端

選擇特定的客戶端可以存取此 Function（覆蓋角色設定）：

```
特別允許:
  ✓ 行動應用程式 iOS (client_123)
  ✓ 合作夥伴 API (client_456)
```

#### 拒絕的客戶端

明確拒絕特定客戶端存取此 Function：

```
明確拒絕:
  ✗ 測試客戶端 (client_789)
```

## 權限測試工具

### 測試客戶端權限

在配置權限後，使用測試工具驗證設定是否正確：

1. 進入「Permissions」→「權限測試」
2. 選擇要測試的客戶端
3. 選擇要測試的 API Function
4. 點擊「測試」按鈕

**測試結果**:

```
客戶端: 行動應用程式 iOS
Function: user.update
結果: ✓ 允許

權限來源:
  - 角色「使用者」允許此 Function
  - 沒有明確的拒絕規則

生效的限制:
  - 速率限制: 600 次/分鐘
  - IP 限制: 無
```

### 模擬 API 請求

模擬實際的 API 請求，測試完整的驗證和授權流程：

1. 選擇客戶端
2. 輸入 API Function 和參數
3. 點擊「模擬請求」
4. 查看結果

**範例**:

```
客戶端: 行動應用程式 iOS
Function: user.update
參數:
{
  "user_id": 123,
  "name": "新名稱"
}

結果: ✓ 成功
HTTP 狀態碼: 200
回應時間: 0.045s
```

## 審計和監控

### 權限變更日誌

系統會記錄所有權限相關的變更：

| 時間 | 操作者 | 操作類型 | 目標 | 變更內容 |
|------|--------|---------|------|---------|
| 10:30 | admin | 新增角色 | 內容編輯者 | 創建新角色 |
| 10:25 | admin | 修改權限 | 使用者角色 | 新增 content.create 權限 |
| 10:20 | admin | 分配角色 | 客戶端 #123 | 分配「使用者」角色 |

### 權限使用統計

查看權限的使用情況：

- **最常使用的 Function**: 哪些 Function 被呼叫最多
- **權限拒絕統計**: 哪些權限被拒絕最多
- **角色使用分布**: 各角色的客戶端數量

### 權限告警

設定告警規則，當發生特定事件時接收通知：

**可用告警**:
- 權限拒絕次數超過閾值
- 新客戶端被分配高權限角色
- 權限配置被修改
- 異常的權限使用模式

## 最佳實踐

### 權限設計原則

#### 1. 最小權限原則

只授予完成任務所需的最小權限。

**範例**:

```
❌ 錯誤: 為所有客戶端分配「管理員」角色
✓ 正確: 根據實際需求分配適當的角色
```

#### 2. 角色分離

將不同職責分配到不同角色，避免權限過度集中。

**範例**:

```
角色設計:
  - 內容創建者: 可以創建和編輯內容
  - 內容審核者: 可以審核和發布內容
  - 內容管理員: 可以刪除和管理所有內容
```

#### 3. 使用角色而非直接分配權限

優先使用角色管理權限，只在特殊情況下直接分配 Function 權限。

**優點**:
- 易於管理和維護
- 權限變更只需修改角色
- 清晰的權限結構

#### 4. 定期審查權限

定期審查和更新權限配置：

- 每季度審查角色和權限
- 移除不再需要的權限
- 檢查是否有權限過度授予的情況

### 權限命名規範

使用清晰、一致的命名規範：

**格式**: `{資源類型}.{資源}.{操作}`

**範例**:

```
✓ 好的命名:
  - function.user.read
  - function.order.create
  - function.report.export

❌ 不好的命名:
  - user_read
  - createOrder
  - export-report
```

### 環境分離

為不同環境使用不同的權限配置：

```
開發環境:
  - 寬鬆的權限設定
  - 允許測試所有功能
  
測試環境:
  - 模擬生產環境的權限
  - 用於驗證權限配置
  
生產環境:
  - 嚴格的權限控制
  - 遵循最小權限原則
```

### 文件化

為每個角色和重要的權限配置撰寫文件：

```
角色: 內容編輯者

用途:
  負責創建和編輯網站內容

權限:
  - 可以創建新內容
  - 可以編輯自己創建的內容
  - 可以提交內容供審核
  - 不能刪除內容
  - 不能發布內容

適用對象:
  - 內容團隊成員
  - 外部內容貢獻者
```

## 故障排除

### 客戶端無法存取 Function

**檢查清單**:

1. ✓ 客戶端是否已啟用？
2. ✓ 客戶端是否有適當的角色？
3. ✓ 角色是否包含該 Function 的權限？
4. ✓ 是否有明確的拒絕規則？
5. ✓ Function 是否已啟用？
6. ✓ Function 的存取級別設定是否正確？

**除錯步驟**:

1. 使用權限測試工具測試客戶端權限
2. 查看權限矩陣確認角色權限
3. 檢查客戶端的特定 Function 權限
4. 查看安全日誌了解拒絕原因

### 權限配置衝突

**症狀**: 客戶端的實際權限與預期不符

**可能原因**:
- 多個角色的權限衝突
- 明確允許和明確拒絕衝突
- 權限優先級理解錯誤

**解決方案**:
1. 檢查客戶端的所有角色
2. 檢查是否有明確的允許或拒絕規則
3. 使用權限測試工具查看最終生效的權限
4. 參考權限優先級規則

### 批次操作失敗

**可能原因**:
- 選擇的客戶端數量過多
- 某些客戶端正在使用中
- 權限不足

**解決方案**:
1. 減少批次操作的客戶端數量
2. 在低峰時段執行批次操作
3. 檢查操作者的管理員權限

## 常見問題

### Q: 如何為新客戶端快速設定權限？

A: 
1. 創建客戶端時選擇適當的角色模板
2. 如果需要特殊權限，再額外配置
3. 使用權限測試工具驗證設定

### Q: 可以為客戶端設定臨時權限嗎？

A: 目前系統不直接支援臨時權限，但可以通過以下方式實現：
1. 創建臨時角色並設定過期時間
2. 使用短期 Token（JWT）控制存取時間
3. 手動在特定時間後撤銷權限

### Q: 如何處理權限繼承？

A: 系統不支援角色繼承。如果需要類似功能，可以：
1. 使用權限模板快速創建相似的角色
2. 使用萬用字元授予一組權限
3. 為客戶端分配多個角色

### Q: 權限變更需要多久生效？

A: 權限變更會立即生效。下一個 API 請求就會使用新的權限配置。

### Q: 如何備份權限配置？

A: 
1. 使用匯出功能匯出角色和權限配置
2. 定期備份資料庫
3. 將權限配置納入版本控制系統

### Q: 可以為 API Function 設定不同的操作權限嗎？

A: 目前每個 Function 是一個獨立的權限單位。如果需要更細粒度的控制，建議：
1. 將不同操作拆分為不同的 Function
2. 例如：`user.read`、`user.create`、`user.update`、`user.delete`

### Q: 如何審查和優化權限配置？

A: 
1. 定期查看權限使用統計
2. 識別未使用的權限並移除
3. 檢查權限拒絕日誌，了解是否有配置問題
4. 使用權限矩陣視覺化檢查權限分布
5. 諮詢安全團隊進行權限審查
