# Admin UI - 客戶端管理指南

## 概述

客戶端管理功能允許管理員創建、配置和管理 API 客戶端，包括生成驗證憑證、設定權限和配置速率限制。每個客戶端代表一個使用 API 的應用程式或服務。

## 存取客戶端管理介面

1. 登入 Admin UI
2. 在左側導航選單中點擊「API Clients」
3. 進入客戶端列表頁面

## 客戶端列表頁面

### 頁面功能

客戶端列表頁面顯示所有已註冊的 API 客戶端，提供以下功能：

- **搜尋**: 根據客戶端名稱或 ID 搜尋
- **篩選**: 按狀態（啟用/停用）、類型或標籤篩選
- **排序**: 按名稱、創建時間或最後使用時間排序
- **批次操作**: 批次啟用、停用或刪除客戶端

### 客戶端列表欄位

| 欄位 | 說明 |
|------|------|
| 名稱 | 客戶端的顯示名稱 |
| 客戶端 ID | 唯一識別碼 |
| 類型 | 驗證類型（API Key、JWT、OAuth） |
| 狀態 | 啟用或停用 |
| 速率限制 | 每分鐘請求次數限制 |
| 最後使用 | 最後一次 API 呼叫時間 |
| 操作 | 編輯、查看憑證、撤銷等操作 |

### 快速操作

#### 啟用/停用客戶端

點擊客戶端列表中的開關按鈕即可快速啟用或停用客戶端。

- **啟用**: 客戶端可以正常呼叫 API
- **停用**: 客戶端的所有請求會被拒絕，返回 401 錯誤

#### 查看憑證

點擊「查看憑證」按鈕可以查看客戶端的 API Key 或 Token。

**安全提示**: 憑證只會在創建時完整顯示一次，之後只會顯示部分內容。請妥善保管憑證。

#### 撤銷憑證

點擊「撤銷」按鈕會立即使該客戶端的所有憑證失效。撤銷後需要重新生成憑證。

## 創建新的 API 客戶端

### 步驟 1: 基本資訊

點擊「創建客戶端」按鈕，填寫基本資訊：

#### 必填欄位

- **客戶端名稱**: 顯示名稱，例如「行動應用程式」、「Web 前端」
- **客戶端類型**: 選擇驗證類型
  - **API Key**: 適合伺服器對伺服器通訊
  - **JWT (Bearer Token)**: 適合前端應用程式
  - **OAuth 2.0**: 適合第三方整合
- **描述**: 客戶端的用途說明

#### 選填欄位

- **標籤**: 用於分類和搜尋
- **聯絡人**: 負責人姓名和聯絡方式
- **環境**: 開發、測試或生產環境

#### 範例

```
名稱: 行動應用程式 iOS
類型: JWT (Bearer Token)
描述: 公司官方 iOS 應用程式，用於使用者登入和資料查詢
標籤: mobile, ios, production
聯絡人: 張三 (zhangsan@example.com)
環境: 生產環境
```

### 步驟 2: 驗證設定

根據選擇的客戶端類型，配置驗證相關設定。

#### API Key 類型

**設定項目**:

- **API Key 前綴**: 自動生成，格式為 `ak_live_` 或 `ak_test_`
- **API Key 長度**: 預設 32 字元
- **允許的 IP 位址**: 限制只有特定 IP 可以使用此 API Key（選填）

**範例**:

```
API Key: ak_live_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p
允許的 IP: 203.0.113.0/24, 198.51.100.50
```

#### JWT (Bearer Token) 類型

**設定項目**:

- **Token 有效期限**: Access Token 的有效時間（預設 1 小時）
- **Refresh Token 有效期限**: Refresh Token 的有效時間（預設 30 天）
- **允許 Token 續期**: 是否允許使用 Refresh Token 取得新的 Access Token
- **Token 簽章演算法**: HS256、RS256 等

**範例**:

```
Access Token 有效期限: 3600 秒（1 小時）
Refresh Token 有效期限: 2592000 秒（30 天）
允許 Token 續期: 是
簽章演算法: HS256
```

#### OAuth 2.0 類型

**設定項目**:

- **Client ID**: 自動生成的客戶端識別碼
- **Client Secret**: 自動生成的客戶端密鑰
- **授權類型**: 支援的 OAuth 授權流程
  - Authorization Code
  - Client Credentials
  - Implicit（不建議）
- **Redirect URIs**: 授權後的重定向 URL（多個）
- **Scope**: 允許的權限範圍

**範例**:

```
Client ID: oauth_client_abc123def456
Client Secret: secret_xyz789uvw012
授權類型: Authorization Code, Client Credentials
Redirect URIs:
  - https://app.example.com/callback
  - https://app.example.com/oauth/callback
Scope: read, write, admin
```

### 步驟 3: 速率限制設定

配置客戶端的 API 請求頻率限制。

#### 速率限制選項

- **預設限制**: 使用系統預設的速率限制（60 次/分鐘）
- **自訂限制**: 為此客戶端設定特定的速率限制
- **無限制**: 不限制請求頻率（僅限特殊情況）

#### 自訂速率限制

**設定項目**:

- **請求次數**: 允許的最大請求次數
- **時間視窗**: 時間單位（分鐘、小時、天）
- **突發限制**: 短時間內允許的最大請求次數（選填）

**範例**:

```
基本限制:
  請求次數: 1000
  時間視窗: 1 分鐘
  
突發限制:
  請求次數: 100
  時間視窗: 1 秒
```

#### 速率限制等級

系統提供預設的速率限制等級：

| 等級 | 限制 | 適用對象 |
|------|------|---------|
| 免費 | 60 次/分鐘 | 測試和開發 |
| 基本 | 600 次/分鐘 | 小型應用程式 |
| 專業 | 6000 次/分鐘 | 中型應用程式 |
| 企業 | 60000 次/分鐘 | 大型應用程式 |
| 無限制 | 無限制 | 內部系統 |

### 步驟 4: 權限設定

配置客戶端可以存取的 API Function 和操作權限。

#### 權限配置方式

##### 方式 1: 基於角色的權限

選擇預定義的角色，客戶端會繼承該角色的所有權限。

**預設角色**:

- **訪客**: 只能存取公開的 API Function
- **使用者**: 可以存取一般的 API Function
- **管理員**: 可以存取所有 API Function
- **自訂角色**: 管理員創建的自訂角色

**範例**:

```
角色: 使用者
繼承權限:
  - user.profile (讀取)
  - user.update (更新)
  - order.query (讀取)
  - order.create (創建)
```

##### 方式 2: 基於 Function 的權限

直接選擇客戶端可以存取的 API Function。

**設定步驟**:

1. 點擊「新增 Function 權限」
2. 選擇 API Function
3. 選擇允許的操作（如果 Function 支援多種操作）
4. 儲存設定

**範例**:

```
允許的 Function:
  ✓ user.profile
  ✓ user.update
  ✓ order.query
  ✓ order.create
  ✗ user.delete
  ✗ order.delete
```

#### 權限繼承

如果客戶端同時設定了角色和 Function 權限，最終權限為兩者的聯集。

詳細的權限配置請參閱 [權限配置指南](admin-ui-permissions.md)。

### 步驟 5: 進階設定

#### IP 白名單

限制只有特定 IP 位址可以使用此客戶端的憑證。

**設定方式**:

- 單一 IP: `203.0.113.50`
- IP 範圍: `203.0.113.0/24`
- 多個 IP: 每行一個

**範例**:

```
203.0.113.50
198.51.100.0/24
192.0.2.100
```

#### 允許的來源 (CORS)

如果客戶端是前端應用程式，設定允許的來源網域。

**範例**:

```
https://app.example.com
https://www.example.com
https://mobile.example.com
```

#### Webhook 設定

配置 Webhook URL，當特定事件發生時系統會發送通知。

**支援的事件**:

- 驗證失敗
- 速率限制觸發
- 權限拒絕
- API 錯誤

**範例**:

```
Webhook URL: https://app.example.com/webhooks/api-events
事件: 驗證失敗, 速率限制觸發
```

#### 自訂中繼資料

儲存與客戶端相關的自訂資料（JSON 格式）。

**範例**:

```json
{
  "app_version": "2.1.0",
  "platform": "iOS",
  "department": "行動開發部",
  "cost_center": "CC-1234"
}
```

### 步驟 6: 生成憑證

確認所有設定後，點擊「創建客戶端」按鈕。系統會自動生成驗證憑證。

#### API Key 類型

系統會顯示生成的 API Key：

```
API Key: ak_live_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p

⚠️ 請立即複製並妥善保管此 API Key。
   關閉此視窗後，您將無法再次查看完整的 API Key。
```

#### JWT 類型

系統會顯示 Client ID 和 Client Secret：

```
Client ID: jwt_client_abc123def456
Client Secret: secret_xyz789uvw012pqr345stu678

⚠️ 請立即複製並妥善保管 Client Secret。
   關閉此視窗後，您將無法再次查看完整的 Secret。
```

#### OAuth 2.0 類型

系統會顯示 OAuth 配置資訊：

```
Client ID: oauth_client_abc123def456
Client Secret: secret_xyz789uvw012pqr345stu678

授權端點: https://api.example.com/oauth/authorize
Token 端點: https://api.example.com/oauth/token
Redirect URIs: https://app.example.com/callback

⚠️ 請立即複製並妥善保管 Client Secret。
```

## 管理現有客戶端

### 查看客戶端詳情

點擊客戶端名稱可以查看詳細資訊：

- **基本資訊**: 名稱、類型、狀態等
- **驗證設定**: 憑證資訊（部分遮罩）
- **權限**: 角色和 Function 權限
- **使用統計**: 請求次數、成功率等
- **最近活動**: 最近的 API 呼叫記錄

### 編輯客戶端

1. 在客戶端列表中點擊「編輯」按鈕
2. 修改需要變更的設定
3. 點擊「儲存」按鈕

**可編輯項目**:

- 基本資訊（名稱、描述、標籤）
- 速率限制
- 權限設定
- IP 白名單
- Webhook 設定

**不可編輯項目**:

- 客戶端 ID
- 客戶端類型
- 已生成的憑證（只能撤銷後重新生成）

### 重新生成憑證

如果憑證洩漏或需要更換：

1. 在客戶端詳情頁面點擊「重新生成憑證」
2. 確認操作（舊憑證會立即失效）
3. 複製新的憑證
4. 更新使用該憑證的應用程式

**注意**: 重新生成憑證會立即使舊憑證失效，可能導致使用舊憑證的應用程式無法存取 API。

### 撤銷客戶端

暫時或永久停止客戶端存取 API：

#### 暫時停用

1. 點擊客戶端列表中的開關按鈕
2. 客戶端狀態變為「停用」
3. 所有使用該客戶端憑證的請求會被拒絕

#### 永久刪除

1. 在客戶端詳情頁面點擊「刪除客戶端」
2. 確認刪除操作
3. 客戶端和所有相關資料會被永久刪除

**注意**: 刪除操作無法撤銷。刪除前請確認沒有應用程式正在使用該客戶端。

## 監控客戶端活動

### 使用統計

在客戶端詳情頁面可以查看：

#### 請求統計

- **總請求次數**: 累計的 API 呼叫次數
- **成功請求**: 返回 2xx 狀態碼的請求
- **失敗請求**: 返回 4xx 或 5xx 狀態碼的請求
- **成功率**: 成功請求的百分比

#### 時間分布

- **每小時請求量**: 過去 24 小時的請求分布
- **每日請求量**: 過去 30 天的請求分布
- **尖峰時段**: 請求量最高的時段

#### 效能指標

- **平均回應時間**: 所有請求的平均執行時間
- **P95 回應時間**: 95% 的請求在此時間內完成
- **P99 回應時間**: 99% 的請求在此時間內完成

### 速率限制監控

查看客戶端的速率限制使用情況：

- **當前使用量**: 當前時間視窗內的請求次數
- **剩餘配額**: 還可以發送的請求次數
- **重置時間**: 配額重置的時間
- **觸發次數**: 超過速率限制的次數

### 最近活動

查看最近的 API 請求記錄：

| 時間 | Function | 狀態 | 執行時間 | IP 位址 |
|------|----------|------|---------|---------|
| 10:30:15 | user.profile | 200 | 0.045s | 203.0.113.50 |
| 10:30:10 | order.query | 200 | 0.123s | 203.0.113.50 |
| 10:30:05 | user.update | 400 | 0.032s | 203.0.113.50 |

點擊記錄可以查看詳細資訊，包括請求參數和回應內容。

### 錯誤分析

查看客戶端遇到的錯誤：

- **錯誤類型分布**: 各種錯誤碼的出現次數
- **常見錯誤**: 最頻繁出現的錯誤
- **錯誤趨勢**: 錯誤率的時間變化

## 批次操作

### 批次啟用/停用

1. 勾選要操作的客戶端
2. 點擊「批次啟用」或「批次停用」按鈕
3. 確認操作

### 批次修改速率限制

1. 勾選要操作的客戶端
2. 點擊「批次修改」按鈕
3. 選擇「速率限制」
4. 設定新的速率限制
5. 確認操作

### 批次匯出

1. 勾選要匯出的客戶端
2. 點擊「匯出」按鈕
3. 選擇匯出格式（JSON 或 CSV）
4. 下載匯出檔案

## 安全最佳實踐

### 憑證管理

1. **立即複製**: 憑證生成後立即複製並妥善保管
2. **安全儲存**: 使用密碼管理器或密鑰管理服務儲存憑證
3. **定期輪換**: 定期更換憑證，特別是長期使用的 API Key
4. **最小權限**: 只授予客戶端必要的權限
5. **監控使用**: 定期檢查客戶端的使用情況，發現異常立即處理

### IP 白名單

1. **限制來源**: 為敏感操作的客戶端設定 IP 白名單
2. **定期審查**: 定期審查和更新 IP 白名單
3. **記錄變更**: 記錄 IP 白名單的變更歷史

### 權限控制

1. **最小權限原則**: 只授予必要的權限
2. **定期審查**: 定期審查客戶端權限，移除不再需要的權限
3. **分離環境**: 開發、測試和生產環境使用不同的客戶端
4. **記錄變更**: 記錄權限變更歷史

### 監控和告警

1. **設定告警**: 為異常活動設定告警（如突然的請求量增加）
2. **定期檢查**: 定期檢查客戶端的使用統計和錯誤率
3. **快速回應**: 發現異常立即調查並採取行動

## 故障排除

### 客戶端無法驗證

**可能原因**:
- 憑證錯誤或過期
- 客戶端已停用
- IP 位址不在白名單中

**解決方案**:
1. 檢查客戶端狀態是否為「啟用」
2. 確認憑證是否正確
3. 檢查 IP 白名單設定
4. 查看安全日誌了解驗證失敗原因

### 超過速率限制

**可能原因**:
- 請求頻率過高
- 速率限制設定過低

**解決方案**:
1. 檢查客戶端的速率限制設定
2. 查看使用統計了解請求模式
3. 考慮提高速率限制或優化應用程式的請求頻率
4. 實作請求佇列或批次處理

### 權限被拒絕

**可能原因**:
- 客戶端沒有存取該 Function 的權限
- Function 已停用

**解決方案**:
1. 檢查客戶端的權限設定
2. 確認 Function 是否已啟用
3. 為客戶端新增必要的權限

## 常見問題

### Q: 如何為不同環境創建客戶端？

A: 建議為每個環境（開發、測試、生產）創建獨立的客戶端，使用標籤或命名規範區分。例如：
- `MyApp - Development`
- `MyApp - Testing`
- `MyApp - Production`

### Q: API Key 和 JWT Token 該如何選擇？

A: 
- **API Key**: 適合伺服器對伺服器的通訊，長期有效，管理簡單
- **JWT Token**: 適合前端應用程式，支援過期和續期，安全性較高

### Q: 如何處理憑證洩漏？

A: 
1. 立即撤銷或停用該客戶端
2. 重新生成新的憑證
3. 更新所有使用該憑證的應用程式
4. 檢查日誌確認是否有異常使用
5. 考慮啟用 IP 白名單增加安全性

### Q: 可以為一個應用程式創建多個客戶端嗎？

A: 可以。例如，可以為同一個應用程式的不同模組或功能創建不同的客戶端，以便更細粒度地控制權限和監控使用情況。

### Q: 如何限制客戶端只能在特定時間存取 API？

A: 目前系統不直接支援時間限制，但可以通過以下方式實現：
1. 使用短期 Token（JWT）並控制 Token 的發放時間
2. 在應用程式層面實作時間檢查
3. 聯繫管理員開發自訂的時間限制功能

### Q: 客戶端刪除後可以恢復嗎？

A: 不可以。刪除操作是永久的，無法恢復。建議在刪除前先停用客戶端，確認沒有問題後再刪除。

### Q: 如何匯出所有客戶端的配置？

A: 
1. 在客戶端列表頁面勾選「全選」
2. 點擊「匯出」按鈕
3. 選擇 JSON 格式
4. 下載匯出檔案

匯出的檔案可用於備份或遷移到其他環境。
